<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Task & Idea Manager Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .summary-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .summary-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .template-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 4px solid #667eea;
        }

        .template-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .template-card.idea {
            border-left-color: #4285f4;
        }

        .template-card.task {
            border-left-color: #34a853;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .template-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }

        .template-type {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .template-type.idea {
            background: #e3f2fd;
            color: #1976d2;
        }

        .template-type.task {
            background: #e8f5e8;
            color: #388e3c;
        }

        .template-info {
            margin-bottom: 10px;
        }

        .template-info p {
            margin-bottom: 5px;
            color: #666;
        }

        .template-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .stat-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
        }

        .progress-container {
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-weight: bold;
            color: #333;
        }

        .template-link {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.9rem;
            transition: transform 0.3s ease;
            text-align: center;
            width: 100%;
        }

        .template-link:hover {
            transform: scale(1.05);
            text-decoration: none;
            color: white;
        }

        .charts-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .no-data {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 50px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .templates-grid {
                grid-template-columns: 1fr;
            }
            
            .template-stats {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .template-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Enhanced Dashboard Styles */
        .overdue-section {
            margin: 15px 0;
            padding: 10px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 4px;
        }

        .overdue-section h4 {
            margin: 0 0 10px 0;
            color: #856404;
            font-size: 0.9rem;
        }

        .overdue-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .overdue-table th,
        .overdue-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .overdue-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }

        .overdue-table td:last-child {
            text-align: center;
            font-weight: bold;
            color: #dc3545;
        }

        .error-message {
            color: #721c24;
            font-size: 0.8rem;
            margin: 5px 0;
            font-style: italic;
        }

        .info-message {
            color: #856404;
            font-size: 0.8rem;
            margin: 5px 0;
            font-style: italic;
        }

        .card-chart-container {
            margin-top: 15px;
            height: 120px;
            position: relative;
        }

        .card-chart {
            width: 100% !important;
            height: 120px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Task & Idea Manager Dashboard</h1>
            <p>Monitor your templates and track progress</p>
        </div>

        <div class="summary-cards" id="summaryCards">
            <!-- Summary cards will be populated by JavaScript -->
        </div>

        <div class="templates-grid" id="templatesGrid">
            <!-- Template cards will be populated by JavaScript -->
        </div>

        <div class="charts-section">
            <div class="charts-grid">
                <div>
                    <div class="chart-title">Progress Overview</div>
                    <div class="chart-container">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>
                <div>
                    <div class="chart-title">Task Status Distribution</div>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('=== HTML SCRIPT STARTING ===');
        
        // Get data from server-side template
        console.log('Step A: About to parse template data');
        
        var dashboardData;
        try {
            // The template injects the data directly as JavaScript object
            dashboardData = <?= JSON.stringify(dashboardData) ?>;
            console.log('Step B: Raw data received');
            console.log('Step C: Data type:', typeof dashboardData);
            console.log('Step D: Data is array:', Array.isArray(dashboardData));
            
            // If it's a string, parse it
            if (typeof dashboardData === 'string') {
                console.log('Step E: Data is string, parsing JSON...');
                dashboardData = JSON.parse(dashboardData);
                console.log('Step F: Parsed data type:', typeof dashboardData);
                console.log('Step G: Parsed data is array:', Array.isArray(dashboardData));
            }
            
            console.log('Step H: Final data length:', dashboardData ? dashboardData.length : 'null/undefined');
            console.log('Step I: Final data:', dashboardData);
            
        } catch (e) {
            console.error('ERROR: Failed to parse template data:', e);
            dashboardData = [];
        }
        
        console.log('=== INITIALIZING DASHBOARD ===');
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting dashboard initialization');
            
            if (!dashboardData || dashboardData.length === 0) {
                console.log('No data found, showing empty message');
                console.log('Data check - dashboardData:', dashboardData);
                showNoDataMessage();
                return;
            }
            
            console.log(`Rendering ${dashboardData.length} cards`);
            console.log('Sample card data:', dashboardData[0]);
            
            try {
                console.log('Creating summary cards...');
                createSummaryCards(dashboardData);
                console.log('Summary cards created');
                
                console.log('Creating template cards...');
                createTemplateCards(dashboardData);
                console.log('Template cards created');
                
                console.log('Creating charts...');
                createCharts(dashboardData);
                console.log('Charts created');
                
                // Update header info
                document.querySelector('.header p').textContent = 
                    `${dashboardData.length} templates ‚Ä¢ Updated: ${new Date().toLocaleString()}`;
                console.log('Header updated');
                
            } catch (error) {
                console.error('Error during rendering:', error);
                document.getElementById('templatesGrid').innerHTML = 
                    '<div class="no-data">Rendering error: ' + error.message + '</div>';
            }
        });
        
        function initializeDashboard() {
            // This function is now handled by DOMContentLoaded
        }

        function showNoDataMessage() {
            document.getElementById('templatesGrid').innerHTML = 
                '<div class="no-data">No templates found. Create your first Idea or Task template to get started!</div>';
        }

        function createSummaryCards(dashboardData) {
            console.log('=== CREATE SUMMARY CARDS ===');
            console.log('Input data:', dashboardData);
            
            const totalTemplates = dashboardData.length;
            const totalTasks = dashboardData.reduce((sum, item) => sum + (item.totalTasks || 0), 0);
            const completedTasks = dashboardData.reduce((sum, item) => sum + (item.completedTasks || 0), 0);
            const overdueTasks = dashboardData.reduce((sum, item) => sum + (item.overdueTasks || 0), 0);

            console.log('Calculated totals:', {totalTemplates, totalTasks, completedTasks, overdueTasks});

            const summaryCards = [
                { title: 'Total Templates', number: totalTemplates, icon: 'üìã' },
                { title: 'Total Tasks', number: totalTasks, icon: 'üìù' },
                { title: 'Completed Tasks', number: completedTasks, icon: '‚úÖ' },
                { title: 'Overdue Tasks', number: overdueTasks, icon: '‚ö†Ô∏è' }
            ];

            const summaryHTML = summaryCards.map(card => `
                <div class="summary-card">
                    <h3>${card.icon} ${card.title}</h3>
                    <div class="number">${card.number}</div>
                </div>
            `).join('');

            console.log('Generated HTML length:', summaryHTML.length);
            console.log('HTML preview:', summaryHTML.substring(0, 200));

            const summaryElement = document.getElementById('summaryCards');
            console.log('Summary element found:', !!summaryElement);
            
            if (summaryElement) {
                summaryElement.innerHTML = summaryHTML;
                console.log('Summary cards HTML inserted');
            } else {
                console.error('Could not find summaryCards element');
            }
        }

        function createTemplateCards(dashboardData) {
            console.log('=== CREATE ENHANCED TEMPLATE CARDS ===');
            console.log('Input data for template cards:', dashboardData);
            
            const templatesHTML = dashboardData.map((template, index) => {
                console.log(`Processing template ${index}:`, template);
                
                const isIdea = template.templateName && template.templateName.toLowerCase().includes('idea');
                const typeClass = isIdea ? 'idea' : 'task';
                const progressPercent = template.progressPercent || 0;
                
                // Create overdue tasks section
                let overdueTasksHTML = '';
                if (template.overdueTasks > 0) {
                    if (template.hasError) {
                        overdueTasksHTML = `
                            <div class="overdue-section">
                                <h4>‚ö†Ô∏è Error Loading Overdue Tasks</h4>
                                <p class="error-message">${template.errorMessage}</p>
                            </div>
                        `;
                    } else if (template.overdueTaskDetails && template.overdueTaskDetails.length > 0) {
                        const tasksRows = template.overdueTaskDetails.map(task => `
                            <tr>
                                <td>${task.taskTitle}</td>
                                <td>${task.delayDays} days</td>
                            </tr>
                        `).join('');
                        
                        overdueTasksHTML = `
                            <div class="overdue-section">
                                <h4>üî¥ Delayed Tasks</h4>
                                <table class="overdue-table">
                                    <thead>
                                        <tr>
                                            <th>Task Title</th>
                                            <th>Delay Days</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tasksRows}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    } else {
                        overdueTasksHTML = `
                            <div class="overdue-section">
                                <h4>üìä ${template.overdueTasks} Overdue Tasks</h4>
                                <p class="info-message">Details not available (Dashboard sheet not found)</p>
                            </div>
                        `;
                    }
                }
                
                // Create chart container with unique ID
                const chartId = `chart-${index}`;
                
                console.log(`Template ${index} - isIdea: ${isIdea}, typeClass: ${typeClass}, progress: ${progressPercent}%`);
                
                return `
                    <div class="template-card ${typeClass}">
                        <div class="template-header">
                            <div class="template-title">${template.cardTitle}</div>
                            <div class="template-type ${typeClass}">${isIdea ? 'Idea' : 'Task'}</div>
                        </div>
                        
                        <div class="template-info">
                            <p><strong>Owner:</strong> ${template.sharedWith || 'Unknown'}</p>
                            <p><strong>Created:</strong> ${formatDate(template.dateCreated)}</p>
                            <p><strong>Sheet:</strong> <a href="${template.sheetUrl}" target="_blank">Open</a></p>
                        </div>
                        
                        <div class="template-stats">
                            <div class="stat-item">
                                <div class="stat-number">${template.totalTasks || 0}</div>
                                <div class="stat-label">Total</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${template.completedTasks || 0}</div>
                                <div class="stat-label">Completed</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${template.onTrack || 0}</div>
                                <div class="stat-label">On Track</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${template.overdueTasks || 0}</div>
                                <div class="stat-label">Overdue</div>
                            </div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                            <div class="progress-text">${progressPercent}% Complete</div>
                        </div>
                        
                        ${overdueTasksHTML}
                        
                        <div class="card-chart-container">
                            <canvas id="${chartId}" class="card-chart"></canvas>
                        </div>
                    </div>
                `;
            }).join('');

            console.log('Templates HTML generated, length:', templatesHTML.length);
            console.log('Templates HTML preview:', templatesHTML.substring(0, 300));

            const templatesElement = document.getElementById('templatesGrid');
            console.log('Templates grid element found:', !!templatesElement);
            
            if (templatesElement) {
                templatesElement.innerHTML = templatesHTML;
                console.log('Template cards HTML inserted');
                
                // Create individual charts for each card
                setTimeout(() => {
                    createIndividualCharts(dashboardData);
                }, 100);
            } else {
                console.error('Could not find templatesGrid element');
            }
        }

        function createIndividualCharts(dashboardData) {
            console.log('=== CREATE INDIVIDUAL CHARTS ===');
            
            dashboardData.forEach((template, index) => {
                const chartId = `chart-${index}`;
                const chartElement = document.getElementById(chartId);
                
                if (!chartElement) {
                    console.error(`Chart element ${chartId} not found`);
                    return;
                }
                
                const ctx = chartElement.getContext('2d');
                
                // Data for the chart
                const completed = template.completedTasks || 0;
                const overdue = template.overdueTasks || 0;
                const notEstimated = template.totalTasks - template.estimated || 0;
                const remaining = Math.max(0, template.totalTasks - completed - overdue);
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Completed', 'Overdue', 'Remaining', 'Not Est.'],
                        datasets: [{
                            data: [completed, overdue, remaining, notEstimated],
                            backgroundColor: [
                                '#28a745', // Green for completed
                                '#dc3545', // Red for overdue
                                '#ffc107', // Yellow for remaining
                                '#6c757d'  // Gray for not estimated
                            ],
                            borderColor: [
                                '#1e7e34',
                                '#c82333',
                                '#e0a800',
                                '#545b62'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 9
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log(`Created chart for ${template.cardTitle}`);
            });
        }

        function createCharts(dashboardData) {
            createProgressChart(dashboardData);
            createStatusChart(dashboardData);
        }

        function createProgressChart(dashboardData) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            const labels = dashboardData.map(item => item.cardTitle);
            const progressData = dashboardData.map(item => item.progressPercent || 0);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Progress %',
                        data: progressData,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function createStatusChart(dashboardData) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            const totalCompleted = dashboardData.reduce((sum, item) => sum + (item.completedTasks || 0), 0);
            const totalOnTrack = dashboardData.reduce((sum, item) => sum + (item.onTrack || 0), 0);
            const totalOverdue = dashboardData.reduce((sum, item) => sum + (item.overdueTasks || 0), 0);
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'On Track', 'Overdue'],
                    datasets: [{
                        data: [totalCompleted, totalOnTrack, totalOverdue],
                        backgroundColor: [
                            '#4CAF50',
                            '#FF9800',
                            '#F44336'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function formatDate(dateValue) {
            if (!dateValue) return 'N/A';
            
            const date = new Date(dateValue);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
